# 地址变换高速缓冲(TLB)与内存保护

## 前言

>在之前的文章中，介绍了页表，通过页表可以将每一个程序的虚拟内存映射为真实的物理内存地址，最终进行数据的读取。
>
>但是这种情况会存在一个问题那就是性能问题。
>
>另外，由于CPU的高速缓存L1 Cache分为数据缓存和指令缓存，那么如果将数据解析为指令执行就会存在系统安全问题。
>
>当初的程序在内存中数据和指令的设计是按照固定顺序排列的，那么这就是说明了，我可以直接透过内存看到你的程序栈和方法区等，会存在严重安全问题。

对于高速缓存和主内存，其实最根本的就是**数据和指令的交换与执行**，只是**性能与安全**是一个永恒的话题，才会有了优化与提升。



## 正文

> 本文需要具备的基础知识：知道页表的两种实现方式，以及对应的优缺点；了解高速缓存和内存；有基础的编程经；知道安全问题；知道时间与空间局部性原理。
>

### 一、地址高速缓冲（TLB）

地址高速缓冲，**简称TLB，全称Translation-Lookaside Buffer。**

**TLB是CPU中的一块缓存芯片，其中缓存的内容是进行页表转换之后的地址查询结果。**当后续同一个虚拟地址进行地址转换的时候，直接查表就可以了，所以更快，性能也就更好！

#### 1）地址转换为什么快了？

**时间局部性原理**：因为使用TLB之后，缓存的是进行了多级查页表的结果，在时间局部性的原理中，缓存的结果，会很快被下一次查到，那么就减少了多级的查页表操作。（访问内存的速度远远慢于直接使用TLB）

**空间局部性原理**：虚拟内存中的地址都是按照顺序排列的，CPU在执行指令的时候，只需要按照PC寄存器进行一条条取指令就可以了，所以通常情况下执行的连续几条指令都是虚拟内存中的一个虚拟页。

![空间局部性原理之TLB](42-地址变换高速缓冲(TLB)与内存保护.assets/空间局部性原理之TLB.jpg)



#### 2）TLB的分类有哪些？

TLB完全是缓存的附属产品，那么其必定是在所有的高速缓存中，也就是L1，L2，L3级都是会有，由于L1 Cache比较特殊，基于哈佛结构设计为指令缓存和数据缓存，那么对应的TLB也是两个，分别是**指令的TLB（ITLB）和数据的TLB（DTLB）。**



#### 3）TLB的缓存失效策略？

在高速缓存中使用的是写直达和写回的策略，TLB也可以使用标记的方式，进行在那个数据的标记，实现**写回**的策略。





### 二、内存管理单元（MMU）

内存管单元，简称MMU，全称Memory Management Unit）。

MMU是一个芯片，负责对整个内存的地址转换功能。并且，其还需要完成与TLB的访问和交互。

![内存管理单元](42-地址变换高速缓冲(TLB)与内存保护.assets/内存管理单元.jpg)





### 三、内存保护（Memory Protection）

> 内存保护机制，属于计算机内存管理中最底层的安全保护机制。

#### 1）可执行空间保护（Executable Space Protection）

可执行空间，描述的是**CPU在执行程序的行为。**

但是程序的执行分为两部分，一部分指令的执行，另一部分是数据的读取。

所以，对于可执行保护，也就是将我们的**指令执行赋予执行权限，对于数据的读取不给执行权限。**

在计算机处理数据和指令的时候，其实看到的都是二进制数，如果将数据也给予了执行权限，那么完全可以将**数据内部嵌套执行指令**，此时数据被解析之后，就会发现这是一个指令，然后就执行了，而这个执行的过程不是预期，所有就带来了安全问题。

但是，如果不给数据执行权限，那么，哪怕数据内嵌指令，解析出来的指令因为没有权限而无法执行。

**最常见的例子就是，编程语言中执行指令的函数和SQL注入。**

前者，可以不用函数或者不给予对应函数的执行权限保证安全，后者，可以不要自己拼接字符串执行SQL，使用框架的方法进行拼接。



#### 2）地址空间布局随机化（Address Space Layout Randomization）

在不添加任何策略的时候，执行程序的进程在内存中的布局空间是固定的，**固定是个什么意思呢？**

就是说程序栈，数据，堆，指令代码，都是在自己该有的地方，不会变化，并且还有一定的顺序，想想多可怕，直接就是一个透明的内存排列方式，尤其对于数据，直接内存穿透就可以看到所有的信息了！

所以，**地址空间布局的随机化策略**便应运而生，将进程中的区域位置不再是固定的，**随机去分配**。

在程序执行的时候，你内存中缺页，是触发一个缺页中断就可以解决，但是你把内存中的数据给改了，进程是直接崩溃的，想想windows10的蓝屏操作，直接就干掉了进程。

关于随机化的一个例子就是，**网站的用户名和密码功能，内部存储的是明文，还是密文，还是加盐的密文？**

![地址空间布局随机化](42-地址变换高速缓冲(TLB)与内存保护.assets/地址空间布局随机化.jpg)







## 结束语

**关于TLB，是性能优化典型示范，通过缓存和访问速度的天然差异，提高了性能；**

**关于内存保护，是安全的范例，通过限制执行的权限和随机乱序思想，保证了内存的基础安全。**

关于SQL注入，更多的就涉及编程语言和框架的内容了，但是作为典型的安全典范，还是需要留意的！







## 参考链接

1.彩虹表：[https://zh.wikipedia.org/wiki/%E5%BD%A9%E8%99%B9%E8%A1%A8](https://zh.wikipedia.org/wiki/彩虹表)

2.幽灵漏洞：[https://zh.wikipedia.org/wiki/%E5%B9%BD%E7%81%B5%E6%BC%8F%E6%B4%9E](https://zh.wikipedia.org/wiki/幽灵漏洞)

3.Memory protection：https://en.wikipedia.org/wiki/Memory_protection#Capability-based_addressing







